# Clerk Environment Configuration
# Copy this file to .env and configure for your environment

# Database Configuration
# PostgreSQL connection string for job tracking and site progress
# Format: postgresql://user:password@host:port/database
DATABASE_URL=postgresql://clerk:password@localhost:5432/clerk

# Redis Configuration
# Redis connection string for RQ task queue backend
# Format: redis://host:port/db
REDIS_URL=redis://localhost:6379/0

# Storage directory for site data (default: ../sites)
# This is where all site databases, text files, and PDFs are stored
STORAGE_DIR=../sites

# OCR Backend
# Choose OCR backend: 'tesseract' or 'vision' (macOS Apple Vision framework)
# Default: tesseract
#
# NOTE: Vision framework is significantly faster than Tesseract, but has a known
# issue with RQ workers on macOS: Apple's Objective-C runtime is not fork-safe,
# causing workers to crash with SIGABRT when Vision tries to initialize after fork().
#
# To use Vision, you would need to either:
# - Use a non-forking task queue architecture
# - Pre-initialize Vision before RQ forks (risky)
# - Disable fork safety checks (not recommended: OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES)
#
# For production stability, use tesseract until we implement a non-forking worker model.
DEFAULT_OCR_BACKEND=tesseract

# Worker Configuration
# Number of background workers for each queue type
# Used by scripts/install-workers.sh for LaunchAgent deployment
#
# Queue Architecture:
# - fetch: Fetches agendas/minutes from city websites
# - ocr: OCR processing of PDF pages (parallel, CPU-intensive)
# - compilation: Database compilation and coordinator (core pipeline)
# - extraction: Entity extraction (optional, can run on separate machine)
# - deploy: Deployment to S3/CDN
#
# Core Pipeline (required on prod): fetch → ocr → compilation → deploy
# Optional Pipeline (separate machine): extraction → compilation
#
# Set EXTRACTION_WORKERS=0 if running extraction on a separate machine
FETCH_WORKERS=2
OCR_WORKERS=4
COMPILATION_WORKERS=2
EXTRACTION_WORKERS=0
DEPLOY_WORKERS=1

# Loki URL for log shipping (optional)
# When set, logs are sent to Loki in addition to console
# LOKI_URL=http://your-loki-host:3100

# Testing Configuration (macOS only)
# WeasyPrint requires system libraries from Homebrew on arm64 macOS
# Set this when running tests to ensure libraries are found:
# DYLD_FALLBACK_LIBRARY_PATH=/opt/homebrew/lib
#
# Example: DYLD_FALLBACK_LIBRARY_PATH=/opt/homebrew/lib uv run pytest -v
